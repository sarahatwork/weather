"use strict";angular.module("weatherApp",["ngAnimate","ngRoute","ngTouch","ngStorage"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/weather.html"}).when("/cities/:id",{templateUrl:"views/city-detail.html"})}]),angular.module("weatherApp").controller("WeatherCtrl",["weather","$localStorage","$location","cityNameFilter",function(a,b,c,d){var e=this;this.query="",this.cities=[],this.filterQuery="",this.error="",this.$storage=b.$default({columns:2}),this.cityRows=[],this.roomForButton=!0,this.colSpan=function(){return 12/e.$storage.columns},this.search=function(){a.getCityByQuery(e.query,function(a,b){e.query="",e.cities=a,e.organizeRows(),e.error=b})},this.organizeRows=function(){var a=[];e.cityRows=[];var b=e.$storage.columns-1,c=e.cities.length;e.cities.forEach(function(d,f){var g=f%e.$storage.columns;a.push(d),(g===b||f===c-1)&&(e.cityRows.push(a),a=[])});var d=e.cityRows[e.cityRows.length-1];this.roomForButton=d&&d.length<e.$storage.columns},this.deleteCity=function(b){a.deleteCity(b,function(a){e.cities=a,e.organizeRows()})},this.loadCities=function(){a.loadCities(function(a){e.cities=a,e.organizeRows()})},this.filterCities=function(){a.loadCities(function(a){d(a,e.filterQuery,function(a){e.cities=a,e.organizeRows()})})},this.loadCities(),this.debug=function(){return c.search().debug},this.resetStorage=function(){e.$storage.$reset()}}]),angular.module("weatherApp").filter("urlEncode",function(){return window.encodeURIComponent}),angular.module("weatherApp").service("weather",["$http","$localStorage","$filter","urlEncodeFilter",function(a,b,c,d){var e=this;this.$storage=b.$default({cityIds:[],cityQueries:{},duds:[]}),this.imgFor=function(a){return"http://l.yimg.com/a/i/us/we/52/"+a+".gif"},this.search=function(b,c){var f='select * from weather.forecast where woeid in (select woeid from geo.places(1) where text="'+b+'")',g="https://query.yahooapis.com/v1/public/yql?q="+d(f)+"&format=json&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys";a.get(g).then(function(a){var f=a.data.query.results;if(!f)return e.$storage.duds.push(b),void c(e.cityData(),"Invalid city name.");var g=f.channel,h={};h.name=g.location.city,h.state=g.location.region,h.id="CITY-"+d(h.name)+"_STATE-"+h.state,h.dateUpdated=e.todaysDate(),h.temp=g.item.condition.temp,h.text=g.item.condition.text,h.img=e.imgFor(g.item.condition.code),h.forecast=g.item.forecast.map(function(a){return a.img=e.imgFor(a.code),a}),h.feelsLike=g.wind.chill,h.windSpeed=g.wind.speed,h.humidity=g.atmosphere.humidity,h.visibility=g.atmosphere.visibility,h.sunrise=g.astronomy.sunrise,h.sunset=g.astronomy.sunset,-1===e.$storage.cityIds.indexOf(h.id)&&e.$storage.cityIds.push(h.id),e.$storage.cityQueries[b]||(e.$storage.cityQueries[b]=h.id),e.$storage[h.id]||(e.$storage[h.id]=h),c(e.cityData())})},this.cityData=function(){return e.$storage.cityIds.map(function(a){return e.$storage[a]})},this.getCityByQuery=function(a,b){if(a=a.toLowerCase(),-1!==e.$storage.duds.indexOf(a))return void b(e.cityData(),"Invalid city name.");var c=e.$storage.cityQueries[a];if(c){var d=e.$storage[c].dateUpdated;e.todaysDate()===d?(-1===e.$storage.cityIds.indexOf(c)&&e.$storage.cityIds.push(c),b(e.cityData())):(e.$storage[c]=null,e.search(a,b))}else e.search(a,b)},this.loadCities=function(a){e.$storage.cityIds.length>0?a(e.cityData()):e.getCityByQuery("Jersey City",a)},this.getCityById=function(a,b){b(e.$storage[d(a)])},this.deleteCity=function(a,b){var c=e.$storage.cityIds.indexOf(a);e.$storage.cityIds.splice(c,1),b(e.cityData())},this.todaysDate=function(){return c("date")(new Date,"MM-dd-yyyy")}}]),angular.module("weatherApp").directive("citySummary",function(){return{templateUrl:"views/city-summary.html",restrict:"A",scope:{city:"=",deleteCity:"&"},controller:["$scope",function(a){a.onClickCloseButton=function(){a.deleteCity({cityId:a.city.id})}}]}}),angular.module("weatherApp").directive("addCity",["$timeout",function(a){return{templateUrl:"views/add-city.html",restrict:"A",link:function(b,c){b.showForm=!1,b.$element=c,b.toggleForm=function(){b.showForm=!b.showForm,a(function(){b.$element.find(".add-city-input")[0].focus()}),b.ctrl.error=null}}}}]),angular.module("weatherApp").controller("CityDetailCtrl",["weather","$routeParams",function(a,b){var c=this;this.city={},a.getCityById(b.id,function(a){c.city=a})}]),angular.module("weatherApp").directive("weatherHeaderPanel",function(){return{templateUrl:"views/weather-header-panel.html",restrict:"A"}}),angular.module("weatherApp").filter("cityName",function(){return function(a,b,c){if(b){var d=a.filter(function(a){return b=b.toLowerCase(),-1!==a.name.toLowerCase().indexOf(b)||-1!==a.state.toLowerCase().indexOf(b)});c(d)}else c(a)}}),angular.module("weatherApp").directive("filterForm",function(){return{templateUrl:"views/filter-form.html",restrict:"A"}});