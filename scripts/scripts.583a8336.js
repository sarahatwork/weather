"use strict";angular.module("weatherApp",["ngAnimate","ngRoute","ngTouch","ngStorage"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/weather.html"}).when("/cities/:id",{templateUrl:"views/city-detail.html"})}]),angular.module("weatherApp").controller("WeatherCtrl",["weather","$localStorage","cityNameFilter",function(a,b,c){var d=this;this.query="",this.cities=[],this.filterQuery="",this.error="",this.$storage=b.$default({columns:2}),this.cityRows=[],this.roomForButton=!0,this.colSpan=function(){return 12/d.$storage.columns},this.search=function(){a.getCityByQuery(d.query,function(a,b){d.query="",d.cities=a,d.organizeRows(),d.error=b})},this.organizeRows=function(){var a=[];d.cityRows=[];var b=d.$storage.columns-1,c=d.cities.length;d.cities.forEach(function(e,f){var g=f%d.$storage.columns;a.push(e),(g===b||f===c-1)&&(d.cityRows.push(a),a=[])});var e=d.cityRows[d.cityRows.length-1];this.roomForButton=e&&e.length<d.$storage.columns},this.deleteCity=function(b){a.deleteCity(b,function(a){d.cities=a,d.organizeRows()})},this.loadCities=function(){a.loadCities(function(a){d.cities=a,d.organizeRows()})},this.filterCities=function(){a.loadCities(function(a){c(a,d.filterQuery,function(a){d.cities=a,d.organizeRows()})})},this.loadCities(),this.resetStorage=function(){d.$storage.$reset()}}]),angular.module("weatherApp").filter("urlEncode",function(){return window.encodeURIComponent}),angular.module("weatherApp").service("weather",["$http","$localStorage","$filter","urlEncodeFilter",function(a,b,c,d){var e=this;this.$storage=b.$default({cityIds:[],cityQueries:{},duds:[]}),this.search=function(b,c){var h='select * from weather.forecast where woeid in (select woeid from geo.places(1) where text="'+b+'")',i="https://query.yahooapis.com/v1/public/yql?q="+d(h)+"&format=json&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys";a.get(i).then(function(a){var h=a.data.query.results;if(!h)return e.$storage.duds.push(b),void c(e.updateAndFetchCityData(),"Invalid city name.");var i=h.channel,j={};j.name=i.location.city,j.state=i.location.region,j.id="CITY-"+d(j.name)+"_STATE-"+j.state,j.dateUpdated=g(),j.temp=i.item.condition.temp,j.text=i.item.condition.text,j.img=f(i.item.condition.code),j.forecast=i.item.forecast.map(function(a){return a.img=f(a.code),a}),j.feelsLike=i.wind.chill,j.windSpeed=i.wind.speed,j.humidity=i.atmosphere.humidity,j.visibility=i.atmosphere.visibility,j.sunrise=i.astronomy.sunrise,j.sunset=i.astronomy.sunset,-1===e.$storage.cityIds.indexOf(j.id)&&e.$storage.cityIds.push(j.id),e.$storage.cityQueries[b]=j.id,e.$storage[j.id]=j,c(e.updateAndFetchCityData())})},this.updateAndFetchCityData=function(){return e.$storage.cityIds.map(function(a){var b=e.$storage[a];if(b.dateUpdated!==g()){var c=b.name+", "+b.state;e.search(c,e.updateAndFetchCityData)}return e.$storage[a]})},this.getCityByQuery=function(a,b){if(a=a.toLowerCase(),-1!==e.$storage.duds.indexOf(a))return void b(e.updateAndFetchCityData(),"Invalid city name.");var c=e.$storage.cityQueries[a];c?(-1===e.$storage.cityIds.indexOf(c)&&e.$storage.cityIds.push(c),b(e.updateAndFetchCityData())):e.search(a,b)},this.loadCities=function(a){e.$storage.cityIds.length>0?a(e.updateAndFetchCityData(a)):e.getCityByQuery("Jersey City",a)},this.getCityById=function(a,b){b(e.$storage[d(a)])},this.deleteCity=function(a,b){var c=e.$storage.cityIds.indexOf(a);e.$storage.cityIds.splice(c,1),b(e.updateAndFetchCityData())};var f=function(a){return"http://l.yimg.com/a/i/us/we/52/"+a+".gif"},g=function(){return c("date")(new Date,"MM-dd-yyyy")}}]),angular.module("weatherApp").directive("citySummary",function(){return{templateUrl:"views/city-summary.html",restrict:"A",scope:{city:"=",deleteCity:"&"},controller:["$scope",function(a){a.onClickCloseButton=function(){a.deleteCity({cityId:a.city.id})}}]}}),angular.module("weatherApp").directive("addCity",["$timeout",function(a){return{templateUrl:"views/add-city.html",restrict:"A",link:function(b,c){b.showForm=!1,b.$element=c,b.toggleForm=function(){b.showForm=!b.showForm,a(function(){b.$element.find(".add-city-input")[0].focus()}),b.ctrl.error=null}}}}]),angular.module("weatherApp").controller("CityDetailCtrl",["weather","$routeParams",function(a,b){var c=this;this.city={},a.getCityById(b.id,function(a){c.city=a})}]),angular.module("weatherApp").directive("weatherHeaderPanel",function(){return{templateUrl:"views/weather-header-panel.html",restrict:"A"}}),angular.module("weatherApp").filter("cityName",function(){return function(a,b,c){if(b){var d=a.filter(function(a){return b=b.toLowerCase(),-1!==a.name.toLowerCase().indexOf(b)||-1!==a.state.toLowerCase().indexOf(b)});c(d)}else c(a)}}),angular.module("weatherApp").directive("filterForm",function(){return{templateUrl:"views/filter-form.html",restrict:"A"}}),angular.module("weatherApp").directive("debug",["$location",function(a){return{restrict:"A",transclude:"element",link:function(b,c,d,e,f){void 0!==a.search().debug&&f(b,function(a,b){c.after(a)})}}}]);